<?xml version="1.0" encoding="UTF-8" ?> 

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
  
<mapper namespace="org.activiti.engine.impl.persistence.entity.LockedJobEntityImpl">


    <delete id="deleteLockedMessageJob" parameterType="org.activiti.engine.impl.persistence.entity.LockedMessageJobEntity">
        delete from ${prefix}ACT_RU_LOCKED_JOB where ID_ = #{id} and REV_ = #{revision}
    </delete>

    <delete id="deleteLockedTimerJob" parameterType="org.activiti.engine.impl.persistence.entity.LockedTimerJobEntity">
        delete from ${prefix}ACT_RU_LOCKED_JOB where ID_ = #{id} and REV_ = #{revision}
    </delete>


  <!-- JOB RESULTMAP (FOR TIMER AND MESSAGE) -->

  <resultMap id="jobResultMap" type="org.activiti.engine.impl.persistence.entity.JobEntityImpl">
    <id property="id" column="ID_" jdbcType="VARCHAR" />
    <result property="revision" column="REV_" jdbcType="INTEGER" />
    <result property="lockOwner" column="LOCK_OWNER_" jdbcType="VARCHAR" />
    <result property="lockExpirationTime" column="LOCK_EXP_TIME_" jdbcType="TIMESTAMP" />
    <result property="exclusive" column="EXCLUSIVE_" jdbcType="BOOLEAN" />
    <result property="executionId" column="EXECUTION_ID_" jdbcType="VARCHAR" />
    <result property="processInstanceId" column="PROCESS_INSTANCE_ID_" jdbcType="VARCHAR" />
    <result property="processDefinitionId" column="PROC_DEF_ID_" jdbcType="VARCHAR" />
    <result property="retries" column="RETRIES_" jdbcType="INTEGER" />
    <result property="exceptionByteArrayRef" column="EXCEPTION_STACK_ID_" typeHandler="ByteArrayRefTypeHandler" />
    <result property="exceptionMessage" column="EXCEPTION_MSG_" jdbcType="VARCHAR" />
    <result property="jobHandlerType" column="HANDLER_TYPE_" jdbcType="VARCHAR" />
    <result property="jobHandlerConfiguration" column="HANDLER_CFG_" jdbcType="VARCHAR" />
    <result property="tenantId" column="TENANT_ID_" jdbcType="VARCHAR" />
      <result property="duedate" column="DUEDATE_" jdbcType="TIMESTAMP" />
      <discriminator javaType="string" column="TYPE_">
      <case value="message" resultMap="messageResultMap"/>
      <case value="timer" resultMap="timerResultMap"/>
    </discriminator>
  </resultMap>


    <resultMap id="lockedJobResultMap" type="org.activiti.engine.impl.persistence.entity.LockedJobEntityImpl" extends="jobResultMap">
        <discriminator javaType="string" column="TYPE_">
            <case value="message" resultMap="lockedMessageResultMap"/>
            <case value="timer" resultMap="lockedTimerResultMap"/>
        </discriminator>
    </resultMap>


    <resultMap id="lockedMessageResultMap" type="org.activiti.engine.impl.persistence.entity.LockedMessageJobEntityImpl" extends="lockedJobResultMap">
    </resultMap>

    <resultMap id="lockedTimerResultMap" type="org.activiti.engine.impl.persistence.entity.LockedTimerJobEntityImpl" extends="lockedJobResultMap">
        <result property="repeat" column="REPEAT_" jdbcType="VARCHAR" />
    </resultMap>



  <!-- JOB SELECT (FOR TIMER AND MESSAGE) -->


  <select id="selectLockedExpiredJobs" parameterType="org.activiti.engine.impl.db.ListQueryParameterObject" resultMap="lockedJobResultMap">
     select * from ${prefix}ACT_RU_LOCKED_JOB
     where LOCK_EXP_TIME_ &lt; #{parameter, jdbcType=TIMESTAMP}
  </select>

  <select id="selectLockedJob" parameterType="string" resultMap="lockedJobResultMap">
     select * from ${prefix}ACT_RU_LOCKED_JOB where ID_ = #{id, jdbcType=VARCHAR}
  </select>

    <select id="selectLockedJobsByExecutionId" parameterType="org.activiti.engine.impl.db.ListQueryParameterObject" resultMap="lockedJobResultMap">
        select *
        from ${prefix}ACT_RU_LOCKED_JOB J
        where J.EXECUTION_ID_ = #{parameter}
    </select>

    <select id="selectLockedJobByTypeAndProcessDefinitionId" parameterType="org.activiti.engine.impl.db.ListQueryParameterObject" resultMap="lockedJobResultMap">
        select J.*
        from ${prefix}ACT_RU_LOCKED_JOB J
        where J.HANDLER_TYPE_ = #{parameter.handlerType}
        and J.PROC_DEF_ID_ = #{parameter.processDefinitionId}
    </select>



    <insert id="insertLockedMessageJob" parameterType="org.activiti.engine.impl.persistence.entity.LockedMessageJobEntityImpl">
        insert into ${prefix}ACT_RU_LOCKED_JOB (
        ID_,
        REV_,
        TYPE_,
        LOCK_OWNER_,
        LOCK_EXP_TIME_,
        EXCLUSIVE_,
        EXECUTION_ID_,
        PROCESS_INSTANCE_ID_,
        PROC_DEF_ID_,
        RETRIES_,
        EXCEPTION_STACK_ID_,
        EXCEPTION_MSG_,
        DUEDATE_,
        REPEAT_,
        HANDLER_TYPE_,
        HANDLER_CFG_,
        TENANT_ID_)
        values (#{id, jdbcType=VARCHAR},
        #{revision, jdbcType=INTEGER},
        'message',
        #{lockOwner, jdbcType=VARCHAR},
        #{lockExpirationTime, jdbcType=TIMESTAMP},
        #{exclusive, jdbcType=BOOLEAN},
        #{executionId, jdbcType=VARCHAR},
        #{processInstanceId, jdbcType=VARCHAR},
        #{processDefinitionId, jdbcType=VARCHAR},
        #{retries, jdbcType=INTEGER},
        #{exceptionByteArrayRef, typeHandler=ByteArrayRefTypeHandler},
        #{exceptionMessage, jdbcType=VARCHAR},
        #{duedate, jdbcType=TIMESTAMP},
        #{repeat, jdbcType=VARCHAR},
        #{jobHandlerType, jdbcType=VARCHAR},
        #{jobHandlerConfiguration, jdbcType=VARCHAR},
        #{tenantId, jdbcType=VARCHAR}
        )
    </insert>

    <insert id="insertLockedTimerJob" parameterType="org.activiti.engine.impl.persistence.entity.LockedTimerJobEntityImpl">
        insert into ${prefix}ACT_RU_LOCKED_JOB (
        ID_,
        REV_,
        TYPE_,
        LOCK_OWNER_,
        LOCK_EXP_TIME_,
        EXCLUSIVE_,
        EXECUTION_ID_,
        PROCESS_INSTANCE_ID_,
        PROC_DEF_ID_,
        RETRIES_,
        EXCEPTION_STACK_ID_,
        EXCEPTION_MSG_,
        DUEDATE_,
        REPEAT_,
        HANDLER_TYPE_,
        HANDLER_CFG_,
        TENANT_ID_)
        values (#{id, jdbcType=VARCHAR},
        #{revision, jdbcType=INTEGER},
        'timer',
        #{lockOwner, jdbcType=VARCHAR},
        #{lockExpirationTime, jdbcType=TIMESTAMP},
        #{exclusive, jdbcType=BOOLEAN},
        #{executionId, jdbcType=VARCHAR},
        #{processInstanceId, jdbcType=VARCHAR},
        #{processDefinitionId, jdbcType=VARCHAR},
        #{retries, jdbcType=INTEGER},
        #{exceptionByteArrayRef, typeHandler=ByteArrayRefTypeHandler},
        #{exceptionMessage, jdbcType=VARCHAR},
        #{duedate, jdbcType=TIMESTAMP},
        #{repeat, jdbcType=VARCHAR},
        #{jobHandlerType, jdbcType=VARCHAR},
        #{jobHandlerConfiguration, jdbcType=VARCHAR},
        #{tenantId, jdbcType=VARCHAR}
        )
    </insert>



    <insert id="bulkInsertLockedTimerJob" parameterType="java.util.List">
        INSERT INTO ${prefix}ACT_RU_LOCKED_JOB (
        ID_,
        REV_,
        TYPE_,
        LOCK_OWNER_,
        LOCK_EXP_TIME_,
        EXCLUSIVE_,
        EXECUTION_ID_,
        PROCESS_INSTANCE_ID_,
        PROC_DEF_ID_,
        RETRIES_,
        EXCEPTION_STACK_ID_,
        EXCEPTION_MSG_,
        DUEDATE_,
        REPEAT_,
        HANDLER_TYPE_,
        HANDLER_CFG_,
        TENANT_ID_) VALUES
        <foreach collection="list" item="job" index="index" separator=",">
            (#{job.id, jdbcType=VARCHAR},
            #{revision, jdbcType=INTEGER},
            'timer',
            #{job.lockOwner, jdbcType=VARCHAR},
            #{job.lockExpirationTime, jdbcType=TIMESTAMP},
            #{job.exclusive, jdbcType=BOOLEAN},
            #{job.executionId, jdbcType=VARCHAR},
            #{job.processInstanceId, jdbcType=VARCHAR},
            #{job.processDefinitionId, jdbcType=VARCHAR},
            #{job.retries, jdbcType=INTEGER},
            #{job.exceptionByteArrayRef, typeHandler=ByteArrayRefTypeHandler},
            #{job.exceptionMessage, jdbcType=VARCHAR},
            #{job.duedate, jdbcType=TIMESTAMP},
            #{job.repeat, jdbcType=VARCHAR},
            #{job.jobHandlerType, jdbcType=VARCHAR},
            #{job.jobHandlerConfiguration, jdbcType=VARCHAR},
            #{job.tenantId, jdbcType=VARCHAR})
        </foreach>
    </insert>

    <insert id="bulkInsertLockedTimerJob" databaseId="oracle" parameterType="java.util.List">
        INSERT ALL
        <foreach collection="list" item="job" index="index">
            INTO ${prefix}ACT_RU_LOCKED_JOB (
            ID_,
            REV_,
            TYPE_,
            LOCK_OWNER_,
            LOCK_EXP_TIME_,
            EXCLUSIVE_,
            EXECUTION_ID_,
            PROCESS_INSTANCE_ID_,
            PROC_DEF_ID_,
            RETRIES_,
            EXCEPTION_STACK_ID_,
            EXCEPTION_MSG_,
            DUEDATE_,
            REPEAT_,
            HANDLER_TYPE_,
            HANDLER_CFG_,
            TENANT_ID_) VALUES
            (#{job.id, jdbcType=VARCHAR},
            #{revision, jdbcType=INTEGER},
            'timer',
            #{job.lockOwner, jdbcType=VARCHAR},
            #{job.lockExpirationTime, jdbcType=TIMESTAMP},
            #{job.exclusive, jdbcType=BOOLEAN},
            #{job.executionId, jdbcType=VARCHAR},
            #{job.processInstanceId, jdbcType=VARCHAR},
            #{job.processDefinitionId, jdbcType=VARCHAR},
            #{job.retries, jdbcType=INTEGER},
            #{job.exceptionByteArrayRef, typeHandler=ByteArrayRefTypeHandler},
            #{job.exceptionMessage, jdbcType=VARCHAR},
            #{job.duedate, jdbcType=TIMESTAMP},
            #{job.repeat, jdbcType=VARCHAR},
            #{job.jobHandlerType, jdbcType=VARCHAR},
            #{job.jobHandlerConfiguration, jdbcType=VARCHAR},
            #{job.tenantId, jdbcType=VARCHAR})
        </foreach>
        SELECT * FROM dual
    </insert>

  <insert id="bulkInsertLockedMessageJob" parameterType="java.util.List">
        INSERT INTO ${prefix}ACT_RU_LOCKED_JOB (
        ID_,
        REV_,
        TYPE_,
        LOCK_OWNER_,
        LOCK_EXP_TIME_,
        EXCLUSIVE_,
        EXECUTION_ID_,
        PROCESS_INSTANCE_ID_,
        PROC_DEF_ID_,
        RETRIES_,
        EXCEPTION_STACK_ID_,
        EXCEPTION_MSG_,
        DUEDATE_,
        REPEAT_,
        HANDLER_TYPE_,
        HANDLER_CFG_,
        TENANT_ID_) VALUES
        <foreach collection="list" item="job" index="index" separator=",">
            (#{job.id, jdbcType=VARCHAR},
            #{job.revision, jdbcType=INTEGER},
            'message',
            #{job.lockOwner, jdbcType=VARCHAR},
            #{job.lockExpirationTime, jdbcType=TIMESTAMP},
            #{job.exclusive, jdbcType=BOOLEAN},
            #{job.executionId, jdbcType=VARCHAR},
            #{job.processInstanceId, jdbcType=VARCHAR},
            #{job.processDefinitionId, jdbcType=VARCHAR},
            #{job.retries, jdbcType=INTEGER},
            #{job.exceptionByteArrayRef, typeHandler=ByteArrayRefTypeHandler},
            #{job.exceptionMessage, jdbcType=VARCHAR},
            #{job.duedate, jdbcType=TIMESTAMP},
            #{job.repeat, jdbcType=VARCHAR},
            #{job.jobHandlerType, jdbcType=VARCHAR},
            #{job.jobHandlerConfiguration, jdbcType=VARCHAR},
            #{job.tenantId, jdbcType=VARCHAR})
        </foreach>
    </insert>

    <insert id="bulkInsertLockedMessageJob" databaseId="oracle" parameterType="java.util.List">
        INSERT ALL
        <foreach collection="list" item="job" index="index">
            INTO ${prefix}ACT_RU_LOCKED_JOB (
            ID_,
            REV_,
            TYPE_,
            LOCK_OWNER_,
            LOCK_EXP_TIME_,
            EXCLUSIVE_,
            EXECUTION_ID_,
            PROCESS_INSTANCE_ID_,
            PROC_DEF_ID_,
            RETRIES_,
            EXCEPTION_STACK_ID_,
            EXCEPTION_MSG_,
            DUEDATE_,
            REPEAT_,
            HANDLER_TYPE_,
            HANDLER_CFG_,
            TENANT_ID_) VALUES
            (#{job.id, jdbcType=VARCHAR},
            #{job.revision, jdbcType=INTEGER},
            'message',
            #{job.lockOwner, jdbcType=VARCHAR},
            #{job.lockExpirationTime, jdbcType=TIMESTAMP},
            #{job.exclusive, jdbcType=BOOLEAN},
            #{job.executionId, jdbcType=VARCHAR},
            #{job.processInstanceId, jdbcType=VARCHAR},
            #{job.processDefinitionId, jdbcType=VARCHAR},
            #{job.retries, jdbcType=INTEGER},
            #{job.exceptionByteArrayRef, typeHandler=ByteArrayRefTypeHandler},
            #{job.exceptionMessage, jdbcType=VARCHAR},
            #{job.duedate, jdbcType=TIMESTAMP},
            #{job.repeat, jdbcType=VARCHAR},
            #{job.jobHandlerType, jdbcType=VARCHAR},
            #{job.jobHandlerConfiguration, jdbcType=VARCHAR},
            #{job.tenantId, jdbcType=VARCHAR})
        </foreach>
        SELECT * FROM dual
    </insert>

</mapper>
