<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.activiti.engine.impl.persistence.entity.JobEntityImpl">

    <!-- JOB RESULTMAP (FOR TIMER AND MESSAGE) -->

    <resultMap id="jobResultMap" type="org.activiti.engine.impl.persistence.entity.JobEntityImpl">
        <id property="id" column="ID_" jdbcType="VARCHAR"/>
        <result property="revision" column="REV_" jdbcType="INTEGER"/>
        <result property="lockOwner" column="LOCK_OWNER_" jdbcType="VARCHAR"/>
        <result property="lockExpirationTime" column="LOCK_EXP_TIME_" jdbcType="TIMESTAMP"/>
        <result property="exclusive" column="EXCLUSIVE_" jdbcType="BOOLEAN"/>
        <result property="executionId" column="EXECUTION_ID_" jdbcType="VARCHAR"/>
        <result property="processInstanceId" column="PROCESS_INSTANCE_ID_" jdbcType="VARCHAR"/>
        <result property="processDefinitionId" column="PROC_DEF_ID_" jdbcType="VARCHAR"/>
        <result property="retries" column="RETRIES_" jdbcType="INTEGER"/>
        <result property="exceptionByteArrayRef" column="EXCEPTION_STACK_ID_" typeHandler="ByteArrayRefTypeHandler"/>
        <result property="exceptionMessage" column="EXCEPTION_MSG_" jdbcType="VARCHAR"/>
        <result property="jobHandlerType" column="HANDLER_TYPE_" jdbcType="VARCHAR"/>
        <result property="jobHandlerConfiguration" column="HANDLER_CFG_" jdbcType="VARCHAR"/>
        <result property="tenantId" column="TENANT_ID_" jdbcType="VARCHAR"/>
        <result property="suspensionState" column="SUSPENSION_STATE_" jdbcType="INTEGER"/>
        <discriminator javaType="string" column="TYPE_">
            <case value="message" resultMap="messageResultMap"/>
            <case value="timer" resultMap="timerResultMap"/>
        </discriminator>
    </resultMap>

    <resultMap id="messageResultMap" type="org.activiti.engine.impl.persistence.entity.MessageEntityImpl" extends="jobResultMap">
    </resultMap>

    <resultMap id="timerResultMap" type="org.activiti.engine.impl.persistence.entity.TimerEntityImpl" extends="jobResultMap">
        <result property="duedate" column="DUEDATE_" jdbcType="TIMESTAMP"/>
        <result property="repeat" column="REPEAT_" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- JOB SELECT (FOR TIMER AND MESSAGE) -->

    <select id="selectJobByQueryCriteria" parameterType="org.activiti.engine.impl.JobQueryImpl" resultMap="jobResultMap">
        ${limitBefore}
        select RES.* ${limitBetween} FROM (

        <if test="!onlyTimers">
            <include refid="selectAsyncJobByQueryCriteriaSql"/>
        </if>
        <if test="!onlyMessages and !onlyTimers">
            UNION
        </if>
        <if test="!onlyMessages">
            <include refid="selectTimerJobByQueryCriteriaSql"/>
        </if>
        ) as RES
        ${orderBy}
        ${limitAfter}
    </select>

    <select id="selectJobCountByQueryCriteria" parameterType="org.activiti.engine.impl.JobQueryImpl" resultType="long">
        select SUM(RES.async_cnt + RES.timers_cnt) from (
        <if test="!onlyTimers">
            select count(distinct ASYNC_RES.ID_) as async_cnt, 0 as timers_cnt from (
            <include refid="selectAsyncJobByQueryCriteriaSql"/>
            ) as ASYNC_RES
        </if>
        <if test="!onlyMessages and !onlyTimers">
            UNION
        </if>
        <if test="!onlyMessages">
            select 0 as async_cnt, count(distinct TIMER_RES.ID_) as timers_cnt from (
            <include refid="selectTimerJobByQueryCriteriaSql"/>
            ) as TIMER_RES
        </if>
        ) as RES
    </select>

</mapper>
